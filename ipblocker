#!/usr/bin/env bash
#
# ipblocker
# Auto-detect local IPv4 network, show local neighbors, ask user confirmation,
# then block ICMP echo-request (ping) from the whole detected subnet (or optional single IP).
#
# Usage:
#   sudo ./ipblocker        # interactive: auto-detect + confirm
#   sudo ./ipblocker -y     # non-interactive: auto-detect and proceed
#   sudo ./ipblocker 192.168.2.0/24   # explicitly provide CIDR (skips detection)
#   sudo ./ipblocker --ip 192.168.1.50 # block single IP (interactive unless -y)
#

set -euo pipefail

# Helpers
err()  { echo "ERROR: $*" >&2; }
info() { echo -e "\e[1;34mINFO:\e[0m $*"; }
warn() { echo -e "\e[1;33mWARN:\e[0m $*"; }

# Simple validators (same as before)
is_valid_cidr() {
  local cidr="$1"
  if [[ "$cidr" =~ ^([0-9]{1,3}\.){3}[0-9]{1,3}/([0-9]|[12][0-9]|3[0-2])$ ]]; then
    IFS='/' read -r ip mask <<< "$cidr"
    IFS='.' read -r o1 o2 o3 o4 <<< "$ip"
    for oct in $o1 $o2 $o3 $o4; do
      if (( oct < 0 || oct > 255 )); then
        return 1
      fi
    done
    return 0
  fi
  return 1
}

is_valid_ip() {
  local ip="$1"
  if [[ "$ip" =~ ^([0-9]{1,3}\.){3}[0-9]{1,3}$ ]]; then
    IFS='.' read -r o1 o2 o3 o4 <<< "$ip"
    for oct in $o1 $o2 $o3 $o4; do
      if (( oct < 0 || oct > 255 )); then
        return 1
      fi
    done
    return 0
  fi
  return 1
}

# Ensure running as root
if [[ $EUID -ne 0 ]]; then
  err "This script must be run as root or with sudo."
  exit 2
fi

# Ensure iptables exists
if ! command -v iptables >/dev/null 2>&1; then
  err "iptables command not found. Install iptables or run on a system that has it."
  exit 3
fi

# Parse args
AUTO_YES=0
EXPLICIT_CIDR=""
EXPLICIT_IP=""
while [[ $# -gt 0 ]]; do
  case "$1" in
    -y|--yes) AUTO_YES=1; shift ;;
    --ip) EXPLICIT_IP="$2"; shift 2 ;;
    -*)
      err "Unknown option: $1"; exit 1 ;;
    *)
      # positional: treat first positional as CIDR
      if [[ -z "$EXPLICIT_CIDR" ]]; then
        EXPLICIT_CIDR="$1"
      else
        err "Extra argument: $1"; exit 1
      fi
      shift
      ;;
  esac
done

# Auto-detect IPv4 CIDR if not provided
detect_local_cidr() {
  # Try common and robust methods in order
  # 1) ip -4 route get 8.8.8.8 -> shows src and dev; then fetch ip addr on that dev
  if ip route get 8.8.8.8 >/dev/null 2>&1; then
    read -r _ _ _ via_dev _ < <(ip route get 8.8.8.8 2>/dev/null | awk '{print $1, $2, $3, $4, $5}')
    # but simpler: find dev from "ip route get 8.8.8.8"
    dev=$(ip route get 8.8.8.8 2>/dev/null | sed -n 's/.* dev \([[:alnum:]]\+\).*/\1/p' | head -n1)
  fi

  # If dev not found, fallback to default route
  if [[ -z "${dev:-}" ]]; then
    dev=$(ip route show default 0.0.0.0/0 2>/dev/null | awk '/default/ {print $5; exit}')
  fi

  # If still empty, try ip -o addr show and pick the first non-loopback
  if [[ -z "${dev:-}" ]]; then
    dev=$(ip -o -4 addr show scope global | head -n1 | awk '{print $2}')
  fi

  if [[ -z "${dev:-}" ]]; then
    return 1
  fi

  # Get the CIDR on that device (e.g. 192.168.1.10/24)
  cidr=$(ip -o -f inet addr show dev "$dev" | awk '{print $4}' | head -n1)
  if [[ -z "$cidr" ]]; then
    return 1
  fi

  echo "$dev" "$cidr"
  return 0
}

# Function to add rule if not present
add_rule_if_missing() {
  local src="$1"
  if iptables -C INPUT -s "$src" -p icmp --icmp-type echo-request -j DROP >/dev/null 2>&1; then
    info "Rule already present for $src â€” skipping."
  else
    info "Adding DROP rule for ICMP echo-request from $src"
    iptables -I INPUT -s "$src" -p icmp --icmp-type echo-request -j DROP
  fi
}

# If explicit IP given via --ip, validate and set SINGLE_IP
SINGLE_IP=""
if [[ -n "$EXPLICIT_IP" ]]; then
  if ! is_valid_ip "$EXPLICIT_IP"; then
    err "Invalid IP provided: $EXPLICIT_IP"
    exit 4
  fi
  SINGLE_IP="$EXPLICIT_IP"
fi

# If explicit CIDR provided as positional, validate
DETECTED_DEV=""
DETECTED_CIDR=""
if [[ -n "$EXPLICIT_CIDR" ]]; then
  if ! is_valid_cidr "$EXPLICIT_CIDR"; then
    err "Invalid CIDR provided: $EXPLICIT_CIDR"
    exit 5
  fi
  DETECTED_CIDR="$EXPLICIT_CIDR"
else
  # Auto-detect
  if out=$(detect_local_cidr 2>/dev/null); then
    DETECTED_DEV=$(awk '{print $1}' <<< "$out")
    DETECTED_CIDR=$(awk '{print $2}' <<< "$out")
  else
    err "Fa
